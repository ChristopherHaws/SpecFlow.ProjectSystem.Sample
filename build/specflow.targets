<Project>

  <!--FIXME: This only looks at the first nuget package folder...-->
  <!--<Import Project="$(NuGetPackageRoot)specflow\$(SpecFlowVersion)\tools\TechTalk.SpecFlow.tasks" Condition="Exists('$(NuGetPackageRoot)specflow\$(SpecFlowVersion)\tools\TechTalk.SpecFlow.tasks')" />-->
  <Import Project="$(RestorePackagesPath)\specflow\$(SpecFlowVersion)\tools\TechTalk.SpecFlow.tasks" Condition="Exists('$(RestorePackagesPath)\specflow\$(SpecFlowVersion)\tools\TechTalk.SpecFlow.tasks')" />

  <Target Name="EnsureNuGetPackageBuildImports" BeforeTargets="PrepareForBuild">
    <PropertyGroup>
      <ErrorText>This project references NuGet package(s) that are missing on this computer. Use NuGet Package Restore to download them.  For more information, see http://go.microsoft.com/fwlink/?LinkID=322105. The missing file is {0}.</ErrorText>
    </PropertyGroup>
    <Error Condition="!Exists('$(RestorePackagesPath)\specflow\$(SpecFlowVersion)\tools\TechTalk.SpecFlow.tasks')" Text="$([System.String]::Format('$(ErrorText)', '$(RestorePackagesPath)\specflow\$(SpecFlowVersion)\tools\TechTalk.SpecFlow.tasks'))" />
  </Target>

  <ItemGroup>
    <Compile Remove="**\*.feature.cs" />
  </ItemGroup>

  <!-- this setting is to workaround the bug in VS (does not detect changes during the pre-build event)
       see: https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=423670&wa=wsignin1.0
  -->
  <PropertyGroup>
    <UseHostCompilerIfAvailable>false</UseHostCompilerIfAvailable>
  </PropertyGroup>

  <PropertyGroup>
    <ShowTrace Condition="'$(ShowTrace)'==''">false</ShowTrace>

    <OverwriteReadOnlyFiles Condition="'$(OverwriteReadOnlyFiles)'==''">false</OverwriteReadOnlyFiles>
    <ForceGeneration Condition="'$(ForceGeneration)'==''">false</ForceGeneration>
    <VerboseOutput Condition="'$(VerboseOutput)'==''">false</VerboseOutput>
  </PropertyGroup>

  <PropertyGroup Condition="'$(BuildServerMode)' == ''">
    <BuildServerMode Condition="'$(BuildingInsideVisualStudio)'=='true'">false</BuildServerMode>
    <BuildServerMode Condition="'$(BuildingInsideVisualStudio)'!='true'">true</BuildServerMode>
  </PropertyGroup>

  <PropertyGroup>
    <BuildDependsOn>
      BeforeUpdateFeatureFilesInProject;
      UpdateFeatureFilesInProject;
      AfterUpdateFeatureFilesInProject;
      $(BuildDependsOn);
    </BuildDependsOn>
    <RebuildDependsOn>
      SwitchToForceGenerate;
      $(RebuildDependsOn);
    </RebuildDependsOn>
</PropertyGroup>

  <Target Name="SwitchToForceGenerate" BeforeTargets="BeforeRebuild">
    <PropertyGroup>
      <ForceGeneration>true</ForceGeneration>
      <OnlyUpdateIfChanged>true</OnlyUpdateIfChanged>
    </PropertyGroup>
  </Target>

  <Target Name="UpdateFeatureFilesInProject" BeforeTargets="BeforeCompile">
    <GenerateAll
      ShowTrace="$(ShowTrace)"

      BuildServerMode="$(BuildServerMode)"
      OverwriteReadOnlyFiles="$(OverwriteReadOnlyFiles)"
      
      ProjectPath="$(MSBuildProjectFullPath)"
      ForceGeneration="$(ForceGeneration)"
      VerboseOutput="$(VerboseOutput)">
      <Output TaskParameter="GeneratedFiles" ItemName="SpecFlowGeneratedFiles" />
    </GenerateAll>

    <ItemGroup>
      <Compile Include="@(SpecFlowGeneratedFiles)">
        <Visible>false</Visible>
      </Compile>
    </ItemGroup>
  </Target>

  <Target Name="BeforeUpdateFeatureFilesInProject" />
  <Target Name="AfterUpdateFeatureFilesInProject" DependsOnTargets="UpdateFeatureFilesInProject" />

</Project>
